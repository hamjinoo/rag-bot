# 트러블슈팅 & FAQ

## 1. 기술 이슈 진단표

| 증상                 | 원인 후보                            | 해결 방법                                              |
| -------------------- | ------------------------------------ | ------------------------------------------------------ |
| 업로드 후 검색 안 됨 | 파일 파싱 실패, 청크 메타데이터 누락 | 로그 확인 → 파싱 라이브러리 교체, 메타데이터 필드 점검 |
| 답변이 헛소리        | 유사도 임계치 낮음, 컨텍스트 과다    | `score_threshold` 0.75 이상, 컨텍스트 토큰 1,500 이하  |
| 응답 지연            | 벡터 검색 Top-k 과다, LLM 지연       | `top_k` 3~5로 조정, 질문 캐시, 비동기 처리             |
| 텔레그램 응답 실패   | Webhook 미등록, parse_mode 오류      | `setWebhook` 재실행, Markdown 문법 검사                |
| 카카오 403 에러      | 시그니처 검증 실패                   | `KAKAO_CHANNEL_SECRET` 재확인, HMAC 비교 코드 검증     |
| 관리자 페이지 공백   | API 권한 부족, 데이터 없음           | JWT 만료 여부 확인, 샘플 로그 삽입 후 확인             |
| - OpenAI 429 에러    | 초당 요청 제한 초과                  | 재시도(backoff), 요청 간 200ms 지연, 캐시 도입         |
| - Docker 배포 실패   | 포트 충돌, 환경변수 누락             | `docker ps`로 포트 확인, `.env` 마운트 여부 점검       |

---

## 2. 디버깅 절차

### 2.1 공통
1. `.env` 환경변수 출력(민감정보 제외)
2. `uvicorn` 로그에서 에러 스택 확인
3. 문제 재현 스크립트 작성 → 테스트 추가

### 2.2 파이프라인
- 문제: 특정 문서가 검색되지 않음
  - `chroma.get(where={"doc_id": ...})` 로 색인 상태 확인
  - 청크 생성 단계 로그(`chunk_count`, `characters`) 점검
  - 필요 시 재색인 (`delete` → `add_texts`)
- 문제: `/upload` 422 에러
  - `Content-Type`가 `multipart/form-data`인지 확인
  - 요청 본문에 파일 이름이 있는지 확인, 파일 크기 제한(기본 10MB) 조정

### 2.3 LLM
- API Rate limit → 지수 백오프(Retry after 헤더 사용)
- 비용 급증 → 질문 캐시, FAQ 미리 답변
- 답변 길이 제한 → `max_tokens` 조정 + 후처리로 분할
- “출처 없는 답변” 발생 → 프롬프트에 `if no sources -> REFUSE` 조건 추가, 임계치 상향

### 2.4 배포
- Docker 컨테이너 메모리 부족 → `--memory` 늘리거나 임베딩 로컬 모델 최적화
- HTTPS 오류 → 인증서 만료 여부 확인, 자동 갱신 스크립트 점검
- Webhook 5xx → 서버 로그 + APM(Sentry 등) 연동
- Render/Fly 배포 실패 → 빌드 로그에서 Python 버전 확인, `poetry.lock` 또는 `requirements.txt` 누락 여부 점검

---

## 3. FAQ 스크립트

### Q1. “AI답변에 근거가 없다고 나오는데요?”
- 문서 유사도가 임계치보다 낮을 때 발생합니다.
- 관련 문서를 업로드하거나, 임계치를 0.7까지 낮춰 테스트 후 다시 올려주세요.

### Q2. “사내 보안 정책이 엄격합니다.”
- 온프레미스 배포, VPC 연결, SSO/LDAP 연동 옵션을 안내하세요.
- 로그에는 개인정보를 저장하지 않고, 민감 정보는 마스킹 처리합니다.

### Q3. “정확도는 얼마나 나오나요?”
- Week 4 평가 리포트 기준으로 정답률/근거 일치율 수치를 전달합니다.
- 평가 데이터셋을 고객과 함께 검토해 신뢰도를 높입니다.

### Q4. “데이터는 어떻게 최신화되나요?”
- 웹 대시보드 업로드, 일정 주기 자동 동기화, API 연동 등 3가지 옵션을 제시합니다.
- 고객 IT팀 협력이 필요한 경우 예상 리소스를 미리 안내합니다.

### Q5. “비용이 너무 높지 않나요?”
- Lite 패키지와 Starter 구독의 월 비용을 먼저 제시하고, 필요 기능에 따라 업셀합니다.
- 로컬 임베딩, 캐시, 질문 제한 등 비용 최적화 방안을 함께 설명합니다.
- 토큰 사용 측정 방식과 예상 월간 비용 계산 표를 함께 공유하면 신뢰도를 높일 수 있습니다.

---

## 4. 연락·지원 플로우
- 티켓 발행: Gmail/Slack → 노션 보드 자동 생성 (Zapier 사용)
- SLA
  - Lite: 2영업일
  - Pro 이상: 1영업일
- 심각도 규정
  - P1(서비스 중단): 2시간 이내 대응
  - P2(핵심 기능 오류): 12시간 이내
  - P3(경미한 버그/문의): 24시간 이내

---

## 5. 추가 리소스
- OpenAI 가격표: https://openai.com/pricing
- 카카오 i 오픈빌더 문서: https://i.kakao.com
- 텔레그램 Bot API: https://core.telegram.org/bots/api
- RAG 베스트 프랙티스: https://www.deeplearning.ai/short-courses/
- LangChain Troubleshooting: https://python.langchain.com/docs/troubleshooting

---

## 다음 단계
- Week별 진행 상황을 점검하며 필요한 항목을 이 문서에 추가하세요.
- 반복되는 질문은 FAQ 스크립트에 반영해 고객 커뮤니케이션 효율을 높입니다.

